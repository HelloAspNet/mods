<script>
    var K_DEL_BRANDS, K_NUM_FAKE_BRANDS, K_BLANK_DATA_FLOOR_USE_CACHE;

    K_DEL_BRANDS = '';
    K_SUBMALL_NAME = '';
    K_NUM_FAKE_BRANDS = 0;
    K_BLANK_DATA_FLOOR_USE_CACHE = true;
    K_DEFAULT_DAP_DATA_PATH = 'http://a.vpimg4.com/upload/actpics/uidesign/2016/3m/0308kidacu/cache/dap-reply-cache-201603082000.v4.js';
</script>
<style>
    /*内容展示失败时的提示信息*/
    .sp-page-loading{width: 100%;min-width: 960px;background: url('http://a.vpimg3.com/upload/actpics/act/sp/branches/pc_sp/act-20150806/img/page-loading.gif') no-repeat center #fff;padding: 60px 0;height: 196px;}
    .sp-page-loading-fail{width: 100%;min-width: 960px;background: url('http://a.vpimg3.com/upload/actpics/act/sp/branches/pc_sp/act-20150806/img/page-loading-fail.png') no-repeat center #fff;padding: 60px 0;height: 196px;display: none;position: relative;}
    .sp-page-loading-fail .btn-refrash, .sp-page-loading-fail .link-home{position: absolute;top: 149px;height: 34px;text-indent: -9999px;}
    .sp-page-loading-fail .btn-refrash:hover, .sp-page-loading-fail .link-home:hover{background: rgba(0, 0, 0, 0.05);}
    .sp-page-loading-fail .btn-refrash{left: 50%;width: 137px;margin-left: -141px;}
    .sp-page-loading-fail .link-home{right: 50%;width: 112px;margin-right: -127px;}

    /*档期小盒子*/
    .b226-list-wrap { width: 960px; margin: 0 auto; }
    .b226-list { position: relative; width: 980px; background: url(http://a.vpimg3.com/upload/actpics/uidesign/2016/2m/0208kidfen/placehoder.png) no-repeat left bottom; }
    .b226-zw { width: 226px; height: 375px; float: left; margin: 0 18px 18px 0;}
    .b226 { width: 226px; overflow: hidden; float: left; margin: 19px 19px 0 0; background-color: #fff; box-shadow: 0 0 3px #aaa;}
    .b226-photo { height: 288px; overflow: hidden; position: relative; }
    .b226-mask, .b226-pms { text-align: center; background: rgba(0, 0, 0, 0.7); filter: progid:DXImageTransform.Microsoft.Gradient(GradientType=0, StartColorStr='#b2000000', EndColorStr='#b2000000'); }
    html:root .b226-mask, html:root .b226-pms { filter: progid:DXImageTransform.Microsoft.Gradient(enabled:false); }
    .b226-mask { width: 100%; height: 100%; position: absolute; top: 100%; left: 0; z-index: 2; }
    .b226:hover .b226-mask,.b226-hover .b226-mask { top: 0; }
    .b226-sale-time { font-size: 24px; line-height: 1; text-align: center; color: #f3c950; padding-top: 15px; margin-top: 40px; height: 63px; background: url(http://a.vpimg4.com/upload/actpics/uidesign/2015/8m/0821kid/sale-time.png?v1) no-repeat center top; }
    .b226-sale-tips { font-size: 18px; color: #acacac; padding-top: 3px; }
    .b226-pms { color: #fff; text-align: center; line-height: 2; width: 216px; padding: 0 5px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; position: absolute; left: 0; bottom: 0; z-index: 3; }
    .b226.fav .b226-pms{display: none;}
    .b226-text { padding: 0 15px; height: 86px; }
    .b226-attr { height: 47px; overflow: hidden; }
    .b226-discount { font-size: 12px; color: #acacac; padding-top: 5px; float: right; }
    .b226-discount span { font-size: 26px; color: #f10582; margin-right: 3px; }
    .b226-name { line-height: 15px; height: 30px; overflow: hidden; padding: 10px 3px 0 0; }
    .b226-name a { color: #333; }
    .b226-nfav{color: #adadad;}
    .b226-btn { color: #f10582; text-align: center; line-height: 24px; height: 24px; border: solid 1px #fbb4d9; }
    .b226:hover .b226-btn { color: #fff; background-color: #f10582; border-color: #f10582; }
    .b226-btn a { color: #f10582; display: block; }
    .b226:hover .b226-btn a { color: #fff; }
    .b226-btn-arrow { font-family: "\5B8B\4F53", sans-serif; }
    .b226-name { height: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; /*warm*/ }
    .b226-upnew-ico { position: absolute; right: 0px; bottom: 20px; z-index: 5; }
    /* b226 */

    .fav {}
    .fav-tips { font-size: 14px; color: #fff; width: 100%; padding-bottom: 20px; background: url(http://a.vpimg3.com/upload/actpics/act/sp/branches/pc_sp/act-20150820/img/icon.gif) no-repeat center 17px; position: absolute; left: 0; bottom: 0; }
    .fav-done .fav-tips { display: none; }
    .fav-count { color: #acacac; line-height: 15px; }
    .fav .b226-btn { cursor: pointer; }
    .fav-txt { display: inline-block; padding-left: 20px; background: url(http://a.vpimg4.com/upload/actpics/uidesign/2015/8m/0821kid/fav.png) no-repeat; }
    .fav:hover .fav-txt { background-position: 0 -24px; }
    .fav-done .b226-btn { cursor: default; }
    .fav-done .fav-txt { background-position: 0 -48px; }
    .fav-done:hover .fav-txt { background-position: 0 -72px; }
    /* fav */

    .hb .fav-tips { display: none; }
    .hb-icon { color: #FEDF4F; text-align: center; width: 34px; height: 21px; padding-top: 20px; background: url(http://a.vpimg4.com/upload/actpics/uidesign/2015/9m/0920kid/hb-icon.png) no-repeat; position: absolute; top: 10px; right: 10px; }
    .hb .b226-sale-tips { display: none; }
    .hb-tips { color: #acacac; padding: 30px 0 20px 0; background: url(http://a.vpimg4.com/upload/actpics/uidesign/2015/9m/0920kid/arrow.gif) no-repeat center bottom; margin-bottom: 10px;}
    .hb-tips dt { font-size: 14px; }
    .hb-tips dd { font-size: 16px; }
    .hb-btn { color: #fff; font-size: 20px; line-height: 38px; text-align: center; width: 109px; height: 38px; margin: 0 auto; padding-right: 40px; background: url(http://a.vpimg4.com/upload/actpics/uidesign/2015/8m/0821kid/hb.png) no-repeat; cursor: pointer; }
    .hb-done .hb-icon { color: #fff; background-position: left bottom; }
    .hb-done .hb-btn { background-position: left bottom; cursor: default; }
    /* hb */
</style>

<style>
    /*dap楼层*/
    .dap {  position: relative; background-color: #FEF2F6;}
    .floor-render-data{ padding: 15px 0 70px 0; position: relative;}
    .floor-brands{padding: 20px 0 60px 0; background: url(http://a.vpimg4.com/upload/actpics/uidesign/2016/3m/0308kidacu/warm/dec-discount.png) no-repeat center 0; position: relative;}
    .k-b226-hold{width: 226px; height: 10px; float: left; margin: 19px 19px 0 0;}

    #floor-discount{background-image: url(http://a.vpimg4.com/upload/actpics/uidesign/2016/3m/0308kidacu/warm/dec-discount.png);}/**/
    #floor-milk{background-image: url(http://a.vpimg4.com/upload/actpics/uidesign/2016/3m/0308kidacu/warm/dec-milk.png);}/**/
    #floor-product{background-image: url(http://a.vpimg4.com/upload/actpics/uidesign/2016/3m/0308kidacu/warm/dec-product.v2.png);}/**/
    #floor-toy{background-image: url(http://a.vpimg4.com/upload/actpics/uidesign/2016/3m/0308kidacu/warm/dec-toy.png);}/**/
    #floor-child{background-image: url(http://a.vpimg4.com/upload/actpics/uidesign/2016/3m/0308kidacu/warm/dec-child.png);}/*童装童鞋*/
    #floor-baby{background-image: url(http://a.vpimg4.com/upload/actpics/uidesign/2016/3m/0308kidacu/warm/dec-baby.png);}/*婴幼服饰*/
    #floor-tomorrow{background-image: url(http://a.vpimg4.com/upload/actpics/uidesign/2016/3m/0308kidacu/warm/dec-tomorrow.png); }



    .k-snav{position: fixed; top: 0; right: 50%; margin-right: 590px; width: 110px; color: #FFF; text-align: center; line-height: 31px;}
    .k-snav-bg{background: url(http://a.vpimg4.com/upload/actpics/uidesign/2016/3m/0308kidacu/warm/bg-snav.v2.png) no-repeat center top;}
    .k-snav-bg:hover, .k-snav-item.cur{color: #fff369;}
    .k-snav-head{background-position: center top; height: 135px;}
    .k-snav-foot{background-position: center bottom; height: 31px;}

    .k-snav-ptr{cursor: pointer;}
    .k-snav-item{height: 31px; background-position: center -135px;}


    .k-bnav-ptr{cursor: pointer;}
    .k-bnav-bg{}
    .k-bnav-bg.cur{}
    .k-bnav{position: fixed; bottom: 0; left: 0; width: 100%; height: 56px; z-index: 200; background-color: #000; color: #FFF; text-align: center;}
    .k-bnav-inner{width: 770px; height: 100%; padding: 0 75px 0 115px; margin: 0 auto; margin-left: auto; margin-right: auto; position: relative;}
    .k-bnav-head{position: absolute; width: 101px; height: 86px; left: 14px; bottom: 0; background: url(http://a.vpimg4.com/upload/actpics/uidesign/2016/3m/0308kidacu/warm/bnav-ico.png) no-repeat center top;}
    .k-bnav-foot{position: absolute; width: 56px; height: 100%; right: 19px; top: 0;}
    .k-bnav-item{height: 100%; float: left; }
    .k-bnav-bg:hover, .k-bnav-item.cur{color: #fff369;}
    .k-bnav-title{display: block; height: 48px; line-height: 48px; border-right: 1px solid #000; margin-top: 4px; text-align: center; background-color: #2f2f2f;}
</style>

<!-- DAP 各楼层内容的容器 -->
<div id="dap" class="dap">
    <div id="J-loading-data-box" class="sp-page-loading actjs-highlight"></div>
    <div id="J_repeat-data-box" class="sp-page-loading-fail">
        <a id="J-refresh-data-btn" href="javascript:;" class="btn-refrash">刷新重试</a>
        <a href="http://www.vip.com" class="link-home" target="_blank">返回特卖会 ></a>
    </div>
</div>


<!-- dap 楼层渲染模板 -->
<script type="text/html" id="basic-floor-tpl">
    {{if type === 'html'}}
    <div id="floor-{{ext.floor_code}}" class="floor floor-{{type}} floor-render-{{kext_render}} {{if ext.is_nav}}floor-navable{{/if}}" data-cmsid="{{ext.cmsId}}" data-floorid="{{ext.floor_code}}">
        {{#mixedData}}
    </div>
    {{else}}
    {{include 'brands-floor-tpl'}}
    {{/if}}
</script>


<!-- 类型为 data 的楼层使用的模板，手工导档期数据也用这个模板 -->
<script type="text/html" id="brands-floor-tpl">
    <div id="floor-{{ext.floor_code}}" class="floor floor-{{type}} floor-brands floor-render-{{kext_render}} {{if ext.is_nav}}floor-navable{{/if}}" data-cmsid="{{ext.cmsId}}" data-floorid="{{ext.floor_code}}">
        {{#kext_before_blist}}
        <div class="b226-list-wrap">
            <div class="b226-list clearfix">
                <div class="k-b226-hold"></div>
                {{each mixedData as brand}}
                {{if brand.state === 2 || brand.state === 0 || brand.state === -1 }}
                <div class="b226 J_sn_{{brand.brand_store_sn}} fav" id="J_id_{{brand.id}}" data-bid="{{brand.id}}" data-sn="{{brand.brand_store_sn}}" data-salestart="{{brand.kext_salestart}}" data-salestop="{{brand.kext_salestop}}" data-bname="{{brand.name}}" mars_sead="click_brand_{{ext.floor_code}}" style="display: {{brand.kext_display}}">
                    <div class="b226-photo">
                        <img class="lazy" data-original="{{brand.new_brand_image}}" src="http://s2.vipstatic.com/img/te/vip_loading.gif" alt="{{brand.name}}" width="226" height="288">

                        <div class="b226-discount">{{#brand.discount}}</div>
                        <div class="b226-mask">
                            <div class="b226-sale-time">{{brand.display_starttime | MonthDayHour}}</div>
                            <div class="b226-sale-tips">商品正在路上</div>
                            <div class="fav-tips">订阅开售提醒</div>
                        </div>
                    </div>
                    <div class="b226-text">
                        <div class="b226-attr">
                            <div class="b226-discount">{{#brand.discount}}</div>
                            <div class="b226-name"><a href="http://list.vip.com/{{brand.id}}.html" title="" target="_blank">{{brand.name}}</a></div>
                            <div class="b226-nfav"></div>
                        </div>
                        <div class="b226-btn J_addfav"><span class="fav-txt" mars_sead="act_1117sales_brands_collect_btn">开售提醒</span></div>
                    </div>
                </div>
                {{else}}
                <div class="b226 J_sn_{{brand.brand_store_sn}}" id="J_id_{{brand.id}}" data-bid="{{brand.id}}" data-sn="{{brand.brand_store_sn}}" data-salestart="{{brand.kext_salestart}}" data-salestop="{{brand.kext_salestop}}" data-bname="{{brand.name}}" mars_sead="click_brand_{{ext.floor_code}}" style="display: {{brand.kext_display}}">
                    <div class="b226-photo">
                        <a href="http://list.vip.com/{{brand.id}}.html" title="{{brand.name}}" target="_blank"><img class="lazy" src="http://s2.vipstatic.com/img/te/vip_loading.gif" data-original="{{brand.new_brand_image}}" alt="{{brand.name}}" width="226" height="288"></a>
                        {{if brand.bicon}}<img src="{{brand.bicon}}" class="lazy b226-upnew-ico" data-original="{{brand.bicon}}">{{/if}}
                    </div>
                    <div class="b226-text">
                        <div class="b226-attr">
                            <div class="b226-discount">{{#brand.discount}}</div>
                            <div class="b226-name"><a href="http://list.vip.com/{{brand.id}}.html" title="" target="_blank">{{brand.name}}</a></div>
                            <div class="b226-nfav"></div>
                        </div>
                        <div class="b226-btn">
                            <a href="http://list.vip.com/{{brand.id}}.html" target="_blank">
                                {{if brand.state === 1}}立即抢购{{else}}马上收藏{{/if}}
                                <span class="b226-btn-arrow">></span>
                            </a>
                        </div>
                    </div>
                </div>
                {{/if}}
                {{/each}}
            </div>
        </div>
        {{#kext_after_blist}}
    </div>
</script>

<!-- 左导航 -->
<script type="text/html" id="J_snav_tpl">
    <div class="k-snav" id="J_snav">
        <div class="k-snav-head k-snav-bg">
        </div>
        <div class="k-snav-body">
            {{each floors as floor}}
            {{if floor.ext.is_nav}}
            <div id="J_snav_item_{{floor.ext.floor_code}}" class="k-snav-item k-snav-ptr k-snav-item-{{floor.ext.floor_code}} k-snav-bg" data-floorname="{{floor.ext.floor_code}}" mars_sead="click_leftbar_{{floor.ext.floor_code}}">{{floor.kext_navinfo && floor.kext_navinfo.title || '楼层标题'}}&nbsp;>
            </div>
            {{/if}}
            {{/each}}
        </div>
        <div class="k-snav-foot k-snav-ptr J_snav_back_top k-snav-bg">TOP>
        </div>
    </div>
</script>


<!-- 底导航 -->
<script type="text/html" id="J_bnav_tpl">
    <div class="k-bnav" id="J_bnav">
        <div class="k-bnav-inner">
            <div class="k-bnav-head"></div>
            <div class="k-bnav-body">
                {{each floors as floor}}
                {{if floor.ext.is_nav}}
                <div id="J_bnav_item_{{floor.ext.floor_code}}" class="k-bnav-item k-bnav-item-{{floor.ext.floor_code}} k-bnav-bg k-bnav-ptr" data-floorname="{{floor.ext.floor_code}}" style="width: {{floor.kext_bnav_wid}}" mars_sead="click_bottombar_{{floor.ext.floor_code}}">
                    <i class="k-bnav-title">{{floor.kext_navinfo && floor.kext_navinfo.title || '楼层标题'}}&nbsp;></i>
                </div>
                {{/if}}
                {{/each}}
            </div>
            <div class="k-bnav-foot k-bnav-bg J_bnav_back_top">
                <i class="k-bnav-title k-bnav-ptr">TOP></i>
            </div>
        </div>
    </div>
</script>


<script>

    /*
     功能: 活动的公用代码，通常不需要依赖 DOM 结构
     */
    var ACT = {
        warehouse: $.Cookie.get('vip_wh') || 'VIP_NH',
        userClass: $.Cookie.get('user_class') || 'c',
        navSensor: {
            inited: false,
            running: false,

            //默认参数
            _default: {
                //触发周期
                scroll_exec_period: 200,
                resize_exec_period: 100,
                //窗口宽度临界值
                critical_win_width: 1000,
                //各楼层选择器或者jQ对象
                floors: '.floor-navable',
                //获取楼层的名字
                getFloorName: function($floor) {
                    return $floor.attr('data-floorid');
                },
                //参考点的y坐标, 默认为视口下边缘的视口坐标，可以传递具体的值
                getPtClientY: function(winheight) {
                    return winheight;
                }
            },

            //实际参数
            _options: null,


            binder: {

                on: function($dom, evt, callback, period) {
                    var iToutid;

                    $dom.on(evt, function(event) {
                        if ( iToutid ) {
                            return;
                        }
                        iToutid = setTimeout(function() {
                            iToutid = null;
                            callback();
                        }, period);
                    });
                }
            },

            //初始化
            init: function(options) {
                if ( this.inited ) {
                    return;
                }
                this.inited = true;
                this._options = $.extend({}, this._default, options);
                this.boot();
            },

            //启动
            boot: function() {
                if ( this.running ) {
                    return;
                }

                this.running = true;

                var $win, $doc, $html, $body, $floors,
                        oOldWin, oNewWin,//global
                        _this, iCritical,
                        fScroll, fResize;


                _this = this;
                $win = $(window);
                $doc = $(document);
                $floors = $(this._options.floors);
                oOldWin = {width: $win.width(), height: $win.height()};
                oNewWin = {};

                iCritical = this._options.critical_win_width;

                fScroll = function() {
                    var scrolltop, clienty, pagey, i , l , h, $floor, pos;
                    scrolltop = $doc.scrollTop();
                    clienty = _this._options.getPtClientY(oOldWin.height);
                    pagey = scrolltop + clienty;

                    //找到当前楼层发布事件
                    for ( i = 0 , l = $floors.length; i < l; i++ ) {
                        $floor = $floors.eq(i);
                        offset = $floor.offset();
                        h = $floor.height();
                        if ( pagey >= offset.top && pagey <= (offset.top+h) ) {
                            $.Listeners.pub('k_floor_change').success({
                                newfloor: {name: _this._options.getFloorName($floor)}
                            });
                            break;
                        }
                    }
                };

                fResize = function() {
                    //存放到外层作用域，有用!
                    oNewWin = {
                        width: $win.width(),
                        height: $win.height()
                    };

                    //宽度变化，发布事件
                    if ( oNewWin.width < iCritical ) {
                        $.Listeners.pub('k_win_too_narrow').success({newsize: {width: oNewWin.width}});
                    } else {
                        $.Listeners.pub('k_win_wid_enough').success({newsize: {width: oNewWin.width}});
                    }

                    //高度变化，当前楼层可能变化
                    if ( oNewWin.height !== oOldWin.height ) {
                        fScroll();
                    }

                    oOldWin = oNewWin;
                };

                this.binder.on($win, 'scroll.sensor', fScroll, this._options.scroll_exec_period);
                this.binder.on($win, 'resize.sensor', fResize, this._options.resize_exec_period);
                $win.trigger('scroll.sensor');
                $win.trigger('resize.sensor');
            },

            //停止
            stop: function() {
                if ( !this.running ) {
                    return;
                }
                this.running = false;

                $(window).off('resize.sensor');
                $(document).off('scroll.sensor');
            }
        },

        /*
         功能: 获取当前时间, 当前时间会参考预览参数actTime
         */
        now: function(urlTimePara) {
            var localTime, visitTime;

            //用户指定的预览时间与预览时的本地时间的差
            if ( this._adjustTime == null ) {
                localTime = (new Date()).valueOf();
                visitTime = this.getVisitTime(urlTimePara || 'actTime');
                this._adjustTime = Date.parse(visitTime) - localTime;//ms
            }
            return (new Date()).valueOf() + this._adjustTime;
        },


        /*
         功能: 设置用户本次访问的时间，主要参考url里的actTime，如果没有，则使用当前时间
         */
        setVisitTime: function (urlTimePara) {
            var oTime, sTime, iTime;

            sTime = this.getUrlTime(urlTimePara || 'actTime');
            oTime = sTime ? new Date(sTime) : new Date();
            oTime = oTime || new Date();
            this.visitime = this.getFmtTime('yyyy/MM/dd hh:mm:ss', oTime, true);
        },

        /*
         功能: 获取用户本次访问的时间
         */
        getVisitTime: function (urlTimePara) {
            if (!this.visitime) {
                this.setVisitTime(urlTimePara);
            }
            return this.visitime;
        },


        getFmtTime: function (fmt, time, bCache) {
            var re, oDate, timetype, timestamp, oCache, sFmtTime, oVal;

            //参数修复
            timetype = typeof time;
            if (timetype === 'boolean' || time instanceof Boolean) {
                bCache = time;
                time = undefined;
                timetype = 'undefined';
            }

            //获取时间对象
            if (time instanceof Date) {
                oDate = time;
            } else if (timetype === 'number') {
                oDate = new Date(time);
            } else if (timetype === 'object' && 'valueOf' in time) {
                oDate = new Date(time.valueOf());
            } else {
                oDate = new Date();
            }

            //格式化串
            !fmt && (fmt = '');

            //时间戳
            timestamp = oDate.valueOf();

            //优先从缓存获取
            oCache = this._oFmtTimeCache;
            if (oCache && (sFmtTime = oCache[timestamp + fmt])) {
                return sFmtTime;
            }

            //年月日时分秒 星期日一二三四五六 时间戳
            re = /(y+|M+|d+|h+|m+|s+|S|D|P)/g;

            oVal = {
                'y+': oDate.getFullYear().toString(),
                'M+': (oDate.getMonth() + 1).toString(),
                'd+': oDate.getDate().toString(),
                'h+': oDate.getHours().toString(),
                'm+': oDate.getMinutes().toString(),
                's+': oDate.getSeconds().toString(),
                'S': oDate.getMilliseconds().toString(),
                'D': '日一二三四五六'.charAt(oDate.getDay()),
                'P': timestamp.toString()
            };

            sFmtTime = fmt.replace(re, function (key) {
                var val, iKeyLen, iValLen;
                //毫秒、汉字一到日，时间戳
                if ('SDP'.indexOf(key) >= 0) {
                    return oVal[key];
                }

                //年月日时分秒, key[0] ie7 bug
                val = oVal[key.charAt(0) + '+'];
                iKeyLen = key.length;
                iValLen = val.length;

                //年
                if (key.charAt(0) === 'y') {
                    return (iKeyLen >= iValLen) ? val : val.substr(iValLen - iKeyLen);
                }
                //月日时分秒
                return (iKeyLen <= iValLen) ? val : (0).toFixed(iKeyLen - iValLen).substr(2) + val;
            });

            //缓存
            if (bCache) {
                oCache || (oCache = this._oFmtTimeCache = {});
                oCache[timestamp + fmt] = sFmtTime;
            }

            return sFmtTime;
        },

        /*
         功能: 获取url中的参数,例如actTime
         author: zhiyi.yao
         date: 2016/01/11
         */
        getUrlPara: (function () {
            var params = {};

            location.search.substring(1).replace(/(?:&)?([^=&]+)=([^&]+)/g, function (a, key, value) {
                return params[key] = decodeURIComponent(value);
            });

            return function(paraname){
                return params[paraname] || '';
            };
        })(),

        /*
         功能: 获取url的actTime参数值(做一点格式转换)
         author: zhiyi.yao
         date: 2016/01/11
         */
        getUrlTime: function (paraname) {
            var urltime = this.getUrlPara(paraname || 'actTime') || '';
            return urltime.replace(/-/g, '/');
        }
    };

    var DAP = {
        //渲染器
        _renders: [],

        //默认值
        _default: {
            cmsId: '',
            box: '#dap',

            /*
             默认的错误提示方法，可通过 DAP 初始化参数的同名属性进行改造
             dap 数据加载出错时，默认的提示方法
             */
            error: function () {

            },

            /*
             默认的修改函数，可通过 DAP 初始化参数的同名属性进行改造
             使得可以在渲染前对响应进行任意修改
             */
            modify: function (oDapReply) {
                return oDapReply;
            },

            render: function (oDapReply) {
                if (!(oDapReply && oDapReply.code === 200)) {
                    (this._options.error || this._default.error || $.noop)();
                    return;
                }

                //遍历所有楼层, 找到合适的渲染器，从渲染器获取html代码，拼接并写入到dom
                var i, l, oFloor, aFloor, oRender, aHtml, box;
                aHtml = [];
                aFloor = (oDapReply && oDapReply.result.floors) || [];

                for (i = 0 , l = aFloor.length; i < l; i++) {
                    oFloor = aFloor[i];
                    oRender = this.getRender(oFloor);
                    oRender.setFloor(oFloor);
                    aHtml.push(oRender.html() || '');
                }

                box = (this._options.box || this._default.box);
                $(box).html(aHtml.join(''));
            }
        },

        //初始化的参数，相关参数如未提供，则使用 _default 中对应的参数
        _options: {},


        /*
         执行模块内部对dap的响应进行的扩展
         */
        _extend: function (oDapReply) {
            var i, l, aFloor, oFloor, oRender, oResult;

            //请求成功
            if (oDapReply && oDapReply['code'] === 200 && (oResult = oDapReply.result)) {

                //其实 floors 既不是数组，也不是类数组(无length属性且下标从1开始)，把它转成真正的数组
                aFloor = oResult.floors || [];
                aFloor = oResult.floors = $.map(oResult.floors, function (floorObject, floorIndex) {
                    return floorObject;
                })

                for (i = 0 , l = aFloor.length; i < l; i++) {
                    oFloor = aFloor[i];
                    oRender = this.getRender(oFloor) || {};

                    //楼层的类型(从渲染器的类型获取)
                    oFloor.kext_render = oRender.type || oFloor.type;
                }

            }
            return oDapReply;
        },

        /*
         执行模块外部对dap的响应进行的修改
         */
        _modify: function (oDapReply) {
            var fModify, oModified;
            fModify = this._options.modify || this._default.modify || $.noop;
            (fModify instanceof Function) || (fModify = $.noop);
            oModified = fModify.call(this, oDapReply);
            return oModified ? oModified : oDapReply;
        },

        /*
         执行外部模块要求在dap出错时调用的回调函数
         */
        _error: function (oDapReply) {
            var fError = this._options.error || this._default.error || $.noop;
            (fError instanceof Function) || (fError = $.noop);
            return fError.call(this, oDapReply);
        },

        /*
         通知外界一切准备就绪
         */
        _ready: function (oDapReply) {
            var fReady = this._options.ready || this._default.ready || $.noop;
            (fReady instanceof Function) || (fReady = $.noop);
            return fReady.call(this, oDapReply);
        },


        init: function (options) {
            var _this = this;
            $.extend(this._options, this._default, options);
            this.load();
        },

        load: function () {
            var _this = this;

            var setting = {
                'url': 'http://act.vip.com/act/act_dap.php' + location.search,
                'dataType': 'json',
                'data': {
                    'cmsId': this._options.cmsId
                }
            };


            if (location.host !== 'act.vip.com') {
                setting['dataType'] = 'jsonp';
                setting['jsonpCallback'] = 'getDap';
                setting['cache'] = true;
            }


            function isValidReply(oDapReply) {
                if ( !(oDapReply && oDapReply.code === 200 && oDapReply.result )  ) {
                    return false;
                }

                var floors, index, floor;

                floors = oDapReply.result.floors;

                //至少有一个楼层
                if ( !(floors && '1' in floors) ) {
                    return false;
                }

                //任何数据楼层无数据，该dap响应都视为无效
                for ( index in floors ) {
                    floor = floors[index];
                    if ( floor.type === 'data' ) {
                        if ( !(floor.mixedData && floor.mixedData.length) ) {
                            return false;
                        }
                    }
                }

                return true;
            }


            function renderdap(oDapReply) {
                if (oDapReply && oDapReply['code'] == 200) {
                    //扩展
                    oDapReply = _this._extend(oDapReply);
                    //修改
                    oDapReply = _this._modify(oDapReply);

                    //渲染
                    _this.render(oDapReply);
                    //回调
                    _this._ready(oDapReply);
                    //发布
                    $.Listeners.pub('dapReady').success();
                } else {
                    _this._error();
                }
            }


            $.ajax(setting).done(function (oDapReply) {
                //假如是无效的响应或者某个数据楼层的数据为空，则使用缓存的dap响应
                if ( !isValidReply(oDapReply) ) {
                    oDapReply = K_DAP_DATA_DEFAULT;
                }
                renderdap(oDapReply);
            }).fail(function (oDapReply) {
                oDapReply = K_DAP_DATA_DEFAULT;
                renderdap(oDapReply);
                // _this._error();
            });




            // $.ajax(setting).done(function (oDapReply) {
            //     var fModReply, oModified;

            //     if (oDapReply && oDapReply['code'] == 200) {
            //         //扩展
            //         oDapReply = _this._extend(oDapReply);
            //         //修改
            //         oDapReply = _this._modify(oDapReply);

            //         //渲染
            //         _this.render(oDapReply);
            //         //回调
            //         _this._ready(oDapReply);
            //         //发布
            //         $.Listeners.pub('dapReady').success();

            //     } else {
            //         _this._error();

            //     }
            // }).fail(function (oDapReply) {
            //     _this._error();

            // });
        },

        //渲染
        render: function (oDapReply) {
            var fRender = this._options.render || this._default.render;
            (fRender instanceof Function) || (fRender = $.noop);
            return fRender.call(this, oDapReply);
        },

        //获取匹配的渲染器
        getRender: function (oFloor) {
            var oRender, i, oCurRender;

            oRender = null;

            //从后向前搜索，先搜到的就是要使用的渲染器
            for (i = this._renders.length - 1; i >= 0; i--) {
                oCurRender = this._renders[i];

                //如果能够用于渲染这个楼层
                if (oCurRender.canRender(oFloor)) {
                    oRender = oCurRender;
                    break;
                }
            }

            return oRender;
        },

        //新增楼层渲染器
        addRender: function (oRender) {
            this._renders.push(oRender);
        }
    };


    //收藏
    var Favorite = {
        init: function () {
            var items = this.items = $('.b226'),
                    self = this;

            self.get();

            if ($.Cookie.get('VipLID')) {
                self.show();
            }
            $.Listeners.sub('userLogin').onsuccess(function () {
                self.show();
            });
            items.filter('.fav').on('click', '.b226-btn', function (e) {
                var wrap = $(e.delegateTarget),
                        sn = wrap.data('sn');
                if (wrap.hasClass('fav-done')) {
                    return;
                }
                if ($.Cookie.get('VipLID')) {
                    self.add(sn);
                } else {
                    VIPSHOP.login.init({
                        loginEvent: function () {
                            VIPSHOP.member.chk();
                            $.listeners.pub('userLogin').success();
                            self.add(sn);
                        }
                    });
                }
            });
        },
        show: function () {
            var items = this.items;
            if (!items.length) {
                return;
            }
            $.ajax({
                url: 'http://fav.myopen.vip.com/brand/index',
                type: 'GET',
                dataType: 'jsonp'
            }).done(function (re) {
                if (re.error || re.data.length == 0) {
                    return;
                }
                $.each(re.data, function (i, sn) {
                    var item = items.filter('.J_sn_' + sn);
                    if (item.length) {
                        item.addClass('fav-done').find('.fav-txt').html('已订阅提醒');
                    }
                });
            })
        },
        add: function (sn) {
            var items = this.items;
            $.ajax({
                url: 'http://fav.myopen.vip.com/brand/add',
                type: 'GET',
                dataType: 'jsonp',
                data: {
                    brand_id: sn,
                    source_id: 1
                }
            }).done(function (re) {
                if (re.error == false || re.errorCode == 6) {
                    var item = items.filter('.J_sn_' + sn);
                    item.addClass('fav-done').find('.fav-txt').html('已订阅提醒');
                }
            });
        },
        get : function () {
            var sns = '';
            $.each(this.items, function(index, domBrand) {
                sns += ',' + $(domBrand).attr('data-sn');
            });

            $.ajax({
                url: 'http://fav.myopen.vip.com/brand/fav_count',
                type: 'GET',
                dataType: 'jsonp',
                data: {
                    brand_sn: sns,
                    source_id: 1
                }
            })
                    .done(function(re) {
                        if (re.code == 0) {
                            for (key in re.data ){
                                $('[data-sn="'+ key+'"]').find('.b226-nfav').html(re.data[key]+'人收藏');
                            }
                        }
                    })

        }
    };


    //红包
    var Coupon = {
        utype: VIPSHOP.UINFO.isNewUser() ? 1 : 2,
        init: function () {
            var self = this;
            var items = this.items = $('.b226');

            this.bids = items.map(function () {
                return this.getAttribute('data-bid');
            }).toArray().toString();

            self.get(); //获取档期红包

            //显示用户已领取红包的档期
            if ($.Cookie.get('VipLID')) {
                self.show();
            }
            $.Listeners.sub('userLogin').onsuccess(function () {
                self.show();
            });

            //领取红包
            items.on('click', '.hb-btn', function (e) {
                var item = $(e.delegateTarget),
                        btn = $(this);
                if (item.hasClass('hb-done')) {
                    return;
                }
                if ($.Cookie.get('VipLID')) {
                    self.add(item);
                } else {
                    VIPSHOP.login.init({
                        loginEvent: function () {
                            VIPSHOP.member.chk();//登录成功后回调
                            $.listeners.pub('userLogin').success();
                            btn.trigger('click');
                        }
                    });
                }
            });
        },
        get: function () {
            var self = this;
            $.ajax({
                url: 'http://act.vip.com/act/index_ajax.php',
                dataType: 'jsonp',
                data: {
                    service: 'NewCoupon.getAllBatch',
                    bids: self.bids,
                    mars_cid: $.Cookie.get('mars_cid')
                    //utype: self.utype
                }
            }).done(function (re) {
                if (re.status == 1) {
                    $.each(re.data, function (id, value) {
                        $.each(value, function (cid, val) {
                            if (val.left) {
                                var item = $('#J_id_' + id);
                                var mask = item.find('.b226-mask');
                                item.addClass('hb').data('cid', cid).addClass('J_cid_' + cid);
                                item.find('img').after('<span class="hb-icon">￥' + val.fav + '</span>');
                                if (mask.length) {
                                    mask.append('<dl class="hb-tips"><dt>商品正在路上</dt><dd>领好红包等开抢</dd></dl><div class="hb-btn">' + val.fav + '元红包</div>');
                                }
                            }
                            return false;
                        });
                    });
                }
            });
        },
        show: function () {
            var self = this;
            $.ajax({
                url: 'http://act.vip.com/act/index_ajax.php',
                dataType: 'jsonp',
                data: {
                    service: 'Coupon.getUserCoupon',
                    bids: self.bids,
                    utype: self.utype
                }
            }).done(function (re) {
                if (re.status == 1 && re.data) {
                    var data = re.data.split(',');
                    $.each(data, function (i, cid) {
                        var elem = $('.J_cid_' + cid);
                        elem.addClass('hb-done');
                    });
                }
            })
        },
        add: function (item) {
            var bid = item.data('bid'),
                    cid = item.data('cid');
            $.ajax({
                url: 'http://act.vip.com/act/index_ajax.php',
                dataType: 'jsonp',
                data: {
                    service: 'Coupon.couponBind',
                    bid: bid,
                    cid: cid,
                    utype: 1
                }
            }).done(function (re) {
                if (re.status == 1) {
                    item.addClass('hb-done');
                } else {
                    alert(re['errorMessage']);
                }
            })
        }
    };


    //PMS
    var PMS = {
        show: function () {
            $.ajax({
                url: 'http://pms.vipshop.com/activetips_index.php',
                dataType: 'jsonp',
                jsonpCallback: 'getAllPms',
                cache: true,
                data: {warehouse: ACT.warehouse, customersrc: ACT.userClass}
            }).done(function (re) {
                $('.b226').each(function () {
                    var $this = $(this),
                            bid = $this.data('bid'),
                            pms = re[bid];
                    if (pms) {
                        $this.find('.b226-photo').append('<div class="b226-pms">' + pms['msg'] + '</div>');
                    }
                });
            });
        }
    };


    var Snav = {
        inited: false,
        drawed: false,
        narrow: false,

        _default: {
            //将导航限制在某个容器的上下两边之间
            container: '#dap',
            upperedge: 0,
            loweredge: 0,
            tpl: '',
            aniTime: 200,
            period: 200,
            data: {floors: [], classes: ''},

            getFloor: function(floorname) {
                return $('#floor-' + floorname);
            },

            getNav: function() {
                return $('#J_snav');
            },

            //对楼层进行扩展，扩展之后的属性可以被导航模板使用
            extFloors: function(floors) {
                return floors;
            },

            //导航是否能看到, this 指向 Snav
            visible: function($nav) {
                return $nav.is(':visible');
            },

            //导航是否要显示, this 指向 Snav
            canShow: function(oWin, oBox, oNav) {
                return !this.narrow
                        && oWin.scrollTop >= (this._options.upperedge);
            },

            //导航定位到某处, this 指向 Snav
            locate: function(oWin, oBox, oNav) {
                var iBoxBottom, iNavCssTop;
                iBoxBottom = oBox.top + oBox.height;
                iNavCssTop = (oWin.height - oNav.height)/2;
                iNavCssTop = Math.min(iNavCssTop , iBoxBottom - this._options.loweredge - oWin.scrollTop - oNav.height - iNavCssTop);
                oNav.jqo.css('top', iNavCssTop + 'px');
            },

            //显示隐藏导航，可以通过样式或类达到效果，此处定制可选择不同方式、甚至采用动画
            show: function($nav) {
                $nav.show();
            },
            hide: function($nav) {
                $nav.hide();
            }
        },
        _options: {},

        /*
         事件绑定(回调频率可控)
         在本模块内被用于绑定scroll事件, 特点是，回调函数触发频率可控
         */
        binder: {
            on: function($dom, evt, callback, period) {
                var iToutid = 0;

                $dom.on(evt, function(event) {
                    if ( iToutid ) {
                        return;
                    }
                    iToutid = setTimeout(function() {
                        iToutid = null;
                        callback();
                    }, period);
                });
            }
        },


        init: function(options) {
            if ( this.inited ) {
                return;
            }
            this.inited = true;
            $.extend(this._options, this._default, options);
            var _this, aFloor;
            _this = this;
            aFloor = this._options.data.floors || [];
            this._options.data.floors = this._options.extFloors(aFloor);
            this.draw();
            this.bind();
        },

        draw: function() {
            //首次绘制
            if ( !this.drawed && (this.drawed = true) ) {
                var fHtml = $.Tpl.compile(this._options.tpl);
                $(this._options.container).append(fHtml(this._options.data));
            }

            //显示隐藏定位
            var $box, $nav, $win, oBox, oNav, oWin, visible, stp;

            $box = $(this._options.container);
            $nav = this._options.getNav();
            $win = $(window);

            oWin = {width: $win.width(), height: $win.height(), scrollTop: $win.scrollTop(), jqo: $win};
            oBox = $.extend($box.offset(), {jqo: $box, width: $box.width(), height: $box.height()});
            oNav = $.extend($nav.offset(), {jqo: $nav, width: $nav.width(), height: $nav.height()});
            visible = this._options.visible.call(this, $nav);

            //显示隐藏
            if ( this._options.canShow.call(this, oWin, oBox, oNav) ) {
                if ( !visible ) {
                    this._options.show($nav);
                    visible = true;
                }
            } else {
                if ( visible ) {
                    this._options.hide($nav);
                    visible = false;
                }
            }

            //可见才定位
            if ( visible ) {
                this._options.locate.call(this, oWin, oBox, oNav);
            }
        },

        bind: function() {
            var _this = this, $doc, $nav, $win;

            $.Listeners.sub('k_floor_change').onsuccess(function(data) {
                _this.mark(data.newfloor.name);
            });

            $.Listeners.sub('k_win_too_narrow').onsuccess(function(data){
                _this.narrow = true;
                _this.hide();
            });

            $.Listeners.sub('k_win_wid_enough').onsuccess(function(data) {
                _this.narrow = false;
                _this.show();
            });


            $doc = $(document);
            $nav = this._options.getNav();
            $win = $(window);

            $nav.on('click.snav.item', '.k-snav-item', function(event) {
                var $item, floorname;
                $item = $(this);
                floorname = $item.attr('data-floorname');
                if ( floorname && !$item.hasClass('cur') ) {
                    _this.jump(floorname);
                }
            });

            this.binder.on($win, 'scroll.snav', function(event) {
                if ( _this.narrow ) {
                    return;
                }
                _this.draw();
            }, this._options.period);


            $('.J_snav_back_top').on('click.snav.backtop', function(event) {
                $('html,body').animate({scrollTop: 0}, _this._options.aniTime);
            });
        },

        show: function() {
            this._options.show(this._options.getNav());
            this.draw();
        },
        hide: function() {
            this._options.hide(this._options.getNav());
        },

        //标记某个楼层为当前楼层
        mark: function(floorname) {
            var $item = $('#J_snav_item_' + floorname);
            if ( $item[0] ) {
                $('.k-snav-item').removeClass('cur');
                $item.addClass('cur');
            }
        },

        //跳转到某个楼层
        jump: function(floorname) {
            var $floor;

            $floor = this._options.getFloor(floorname);

            //有效性
            if ( !($floor && $floor[0]) ) {
                return;
            }

            //定制的跳转
            if ( $.isFunction(this._options.jump) ) {
                this._options.jump($floor);
                return;
            }

            $('html,body').animate({scrollTop: $floor.offset().top}, this._options.aniTime);
        }
    };


    var Bnav = {
        inited: false,
        drawed: false,
        narrow: false,

        _default: {
            //将导航限制在某个容器的上下两边之间
            container: '#dap',
            upperedge: 0,
            loweredge: 0,
            tpl: '',
            aniTime: 200,
            period: 200,
            data: {floors: [], classes: ''},

            getFloor: function(floorname) {
                return $('#floor-' + floorname);
            },

            getNav: function() {
                return $('#J_bnav');
            },

            //对楼层进行扩展，扩展之后的属性可以被导航模板使用
            extFloors: function(floors) {
                return floors;
            },

            //导航是否能看到, this 指向 Bnav
            visible: function($nav) {
                return $nav.is(':visible');
            },

            //导航是否要显示, this 指向 Bnav
            canShow: function(oWin, oBox, oNav) {
                return this.narrow
                        && oWin.scrollTop >= (this._options.upperedge);
            },

            //导航定位到某处, this 指向 Bnav
            locate: function(oWin, oBox, oNav) {
            },

            //显示隐藏导航，可以通过样式或类达到效果，此处定制可选择不同方式、甚至采用动画
            show: function($nav) {
                $nav.show();
            },
            hide: function($nav) {
                $nav.hide();
            }
        },
        _options: {},

        /*
         事件绑定(回调频率可控)
         在本模块内被用于绑定scroll事件, 特点是，回调函数触发频率可控
         */
        binder: {
            on: function($dom, evt, callback, period) {
                var iToutid;

                $dom.on(evt, function(event) {
                    if ( iToutid ) {
                        return;
                    }
                    iToutid = setTimeout(function() {
                        iToutid = null;
                        callback();
                    }, period);
                });
            }
        },


        init: function(options) {
            if ( this.inited ) {
                return;
            }
            this.inited = true;
            $.extend(this._options, this._default, options);
            var _this, aFloor;
            _this = this;
            aFloor = this._options.data.floors || [];
            this._options.data.floors = this._options.extFloors(aFloor);
            this.draw();
            this.bind();
        },

        draw: function() {
            //首次绘制
            if ( !this.drawed && (this.drawed = true) ) {
                var fHtml = $.Tpl.compile(this._options.tpl);
                $(this._options.container).append(fHtml(this._options.data));
            }

            //显示隐藏定位
            var $box, $nav, $win, oBox, oNav, oWin, visible, stp;

            $box = $(this._options.container);
            $nav = this._options.getNav();
            $win = $(window);

            oWin = {width: $win.width(), height: $win.height(), scrollTop: $win.scrollTop(), jqo: $win};
            oBox = $.extend($box.offset(), {jqo: $box, width: $box.width(), height: $box.height()});
            oNav = $.extend($nav.offset(), {jqo: $nav, width: $nav.width(), height: $nav.height()});
            visible = this._options.visible.call(this, $nav);

            //显示隐藏
            if ( this._options.canShow.call(this, oWin, oBox, oNav) ) {
                if ( !visible ) {
                    this._options.show($nav);
                    visible = true;
                }
            } else {
                if ( visible ) {
                    this._options.hide($nav);
                    visible = false;
                }
            }

            //可见才定位
            if ( visible ) {
                this._options.locate.call(this, oWin, oBox, oNav);
            }
        },

        bind: function() {
            var _this = this, $doc, $nav, $win;

            $.Listeners.sub('k_floor_change').onsuccess(function(data) {
                _this.mark(data.newfloor.name);
            });

            $.Listeners.sub('k_win_too_narrow').onsuccess(function(data){
                _this.narrow = true;
                _this.show();
            });

            $.Listeners.sub('k_win_wid_enough').onsuccess(function(data) {
                _this.narrow = false;
                _this.hide();
            });


            $doc = $(document);
            $nav = this._options.getNav();
            $win = $(window);

            $nav.on('click.bnav.item', '.k-bnav-item', function(event) {
                var $item, floorname;
                $item = $(this);
                floorname = $item.attr('data-floorname');
                if ( floorname && !$item.hasClass('cur') ) {
                    _this.jump(floorname);
                }
            });

            this.binder.on($win, 'scroll.bnav', function(event) {
                if ( !_this.narrow ) {
                    return;
                }
                _this.draw();
            }, this._options.period);


            $('.J_bnav_back_top').on('click.bnav.backtop', function(event) {
                $('html,body').animate({scrollTop: 0}, _this._options.aniTime);
            });
        },

        show: function() {
            this._options.show(this._options.getNav());
            this.draw();
        },
        hide: function() {
            this._options.hide(this._options.getNav());
        },

        //标记某个楼层为当前楼层
        mark: function(floorname) {
            var $item = $('#J_bnav_item_' + floorname);
            if ( $item[0] ) {
                $('.k-bnav-item').removeClass('cur');
                $item.addClass('cur');
            }
        },

        //跳转到某个楼层
        jump: function(floorname) {
            var $floor;

            $floor = this._options.getFloor(floorname);

            //有效性
            if ( !($floor && $floor[0]) ) {
                return;
            }

            //定制的跳转
            if ( $.isFunction(this._options.jump) ) {
                this._options.jump($floor);
                return;
            }

            $('html,body').animate({scrollTop: $floor.offset().top}, this._options.aniTime);
        }
    };


    /*
     功能: 楼层渲染器(Floor Render), 与样式的耦合是很重的, 所有渲染器名称由 FR 打头

     author: zhiyi.yao
     date: 2016-01-09
     FRHtml: 类型为 html 的楼层的默认渲染器
     FRData: 类型为 data 的楼层的默认渲染器
     FRBArr: 类型为 html 的楼层，里面用 kext-barr 标签将json格式的档期字符串({brands: []})包裹， 该数据会被前端解析并转换为html代码
     */
    function FRHtml(options) {
        //渲染器的类型
        this.type = 'html';
        this._options = {};
        $.extend(this._options, this._default, options);
    }

    FRHtml.prototype = {
        constructor: FRHtml,
        _default: {
            tpl: ''
        },
        //能否用于某个楼层的渲染
        canRender: function (oFloor) {
            return oFloor && oFloor.type === 'html';
        },
        setFloor: function (oFloor) {
            this.data = oFloor;
        },
        html: function (oFloor) {
            var render = $.Tpl.compile(this._options.tpl);
            return render(this.data);
        }
    };

    function FRData(options) {
        //渲染器的类型
        this.type = 'data';
        this._options = {};
        this._visitime = Date.parse(ACT.getVisitTime());
        $.extend(this._options, this._default, options);
        this._aFakeBrands = this.genFakeBrands();
    }

    FRData.prototype = {
        constructor: FRData,

        _default: {
            tpl: '',
            //隐藏已经下线的档期
            hide_offline_brands: true,
            //隐藏未上线的档期
            hide_noready_brands: false,
            //强制隐藏掉的档期
            hide_these_brands: '',
            //使用url里的actTime参数作为当前时间
            set_now_with_urltime: true,
            //在楼层为空时使用假数据的数量
            num_fake_brands: K_NUM_FAKE_BRANDS,
            //假数据
            fake_brand_obj: {
                'id': '620254',
                'name': '暇步士Hush Puppies童装专场',
                'story_logo': 'http://a.vpimg1.com/upload/brand/201506/2015060816534522943.jpg',
                'logo': 'http://a.vpimg1.com/upload/brand/201506/2015060816534433891.jpg',
                'discount': '<span class="salebg2">2.5</span>折起',
                'redirect': '',
                'slogan': '美式休闲品牌童装',
                'index_img2': 'http://c.vpimg1.com/upcb/2016/01/04/115/58451489.jpg',
                'display_starttime': '1452168000',
                'display_endtime': '1452477540',
                'pre_time': '1452009600',
                'brand_store_sn': '10000773',
                'is_warmup': '1',
                'warmup_time': '1451577600',
                'c3_show_from': '1452168000',
                'c3_show_to': '1452477540',
                'sale_status': '3',
                'active_image_one': '',
                'new_brand_image': 'http://c.vpimg1.com/upcb/2016/01/04/166/58457385.jpg',
                'vendor_sale_message': '',
                'state': 2,
                'bicon': '',
                'AUTOSORT': -99988
            },
            //允许修改楼层
            modifyFloor: null,
            //修改档期列表
            modifyBrands: null,
            canRender: function(oFloor) {
                return oFloor && oFloor.type === 'data';
            }
        },

        //生成假数据
        genFakeBrands: function () {
            var aFake, numFake, oFake;
            aFake = [];
            oFake = this._options.fake_brand_obj;
            numFake = this._options.num_fake_brands;
            if (oFake && numFake > 0) {
                //别用 numFake--
                while (numFake) {
                    aFake.push(oFake);
                    numFake--;
                }
            }
            return aFake;
        },

        //能否用于某个楼层的渲染
        canRender: function (oFloor) {
            var fCanRender = this._options.canRender || $.noop;
            return fCanRender(oFloor);
        },

        modifyBrand: function (oBrand) {
            var o = oBrand;

            //提取上下线时间(warmup_time 好像没用)
            var salestart, salestop;

            salestart = (parseInt(oBrand.display_starttime) || 0) * 1000; //同 display_starttime
            salestop = (parseInt(oBrand.display_endtime) || 0) * 1000;//同 display_endtime

            o['kext_salestart'] = ACT.getFmtTime('yyyy/MM/dd hh:mm:ss', salestart, true);
            o['kext_salestop'] = ACT.getFmtTime('yyyy/MM/dd hh:mm:ss', salestop, true);


            //判断是否要显示, 是否隐藏未上线档期，是否隐藏已下线档期
            if ( ( this._options.hide_noready_brands && this._visitime < salestart ) ||
                    ( this._options.hide_offline_brands && this._visitime >= salestop) ) {
                o['kext_display'] = 'none';
            } else {
                o['kext_display'] = 'block';
            }

            //强制隐藏的档期
            if ( this._options.hide_these_brands.indexOf(oBrand.id.toString()) >= 0) {
                o['kext_display'] = 'none';
            }

            return o;
        },

        //对楼层内的数据进行任意的扩展
        modifyFloor: function (oFloor) {
            var fModifyFloor, fModifyBrand;

            fModifyFloor = typeof this._options.modifyFloor === 'function' ?
                    this._options.modifyFloor : $.noop;

            fModifyBrand = typeof this._options.modifyBrand === 'function' ?
                    this._options.modifyBrand : $.noop;


            //先让外部模块对楼层进行修改
            fModifyFloor(oFloor);

            //伪造
            if (this._options.num_fake_brands && oFloor.mixedData.length === 0) {
                oFloor.mixedData = this._aFakeBrands;
            }

            //再对楼层进行扩展

            //再对档期数据进行扩展
            var aBrand, oBrand, i, l;

            aBrand = oFloor.mixedData;

            for (i = 0 , l = aBrand.length; i < l; i++) {
                oBrand = aBrand[i];
                //外部模块先修改
                fModifyBrand(oBrand);
                //本模块后修改
                this.modifyBrand(oBrand);
            }
        },

        setFloor: function (oFloor) {
            this.modifyFloor(oFloor);
            this.data = oFloor;
        },

        html: function () {
            var render = $.Tpl.compile(this._options.tpl);
            return render(this.data);
        }
    };

    function FRBArr(options) {
        FRData.call(this, options);
        this.type = 'barr';
    }

    FRBArr.prototype = new FRData();

    $.extend(FRBArr.prototype, {
        constructor: FRBArr,
        canRender: function (oFloor) {
            return oFloor.type === 'html' && oFloor.mixedData.indexOf('kext-barr') >= 0;
        },
        setFloor: function (oFloor) {
            //解析出json数据
            var oData, sData, start, stop, gtPos, fData;

            start = oFloor.mixedData.indexOf('kext-barr');
            gtPos = oFloor.mixedData.indexOf('>', start);
            stop = oFloor.mixedData.lastIndexOf('kext-barr');

            oFloor.kext_before_blist = oFloor.mixedData.substring(0, start-1);
            sData = oFloor.mixedData.substring(gtPos+1, stop-2) || '{brands: []}';
            oFloor.kext_after_blist = oFloor.mixedData.substring(stop+10);

            fData = new Function('return ' + sData);

            oData = fData() || {brands: []};
            aBrand = oData.brands;

            //过滤出与当前区域匹配的档期
            var i, l, oBrand, aShowBrand, warehosue;
            warehouse = ACT.warehouse.toLowerCase();
            aShowBrand = [];

            for (i = 0 , l = aBrand.length; i < l; i++) {
                oBrand = aBrand[i];
                if ( parseInt(oBrand[warehouse]) === 1 ) {
                    aShowBrand.push(oBrand);
                }
            }

            //保存数据
            oFloor.mixedData = aShowBrand;//覆盖!

            this.modifyFloor(oFloor);
            this.data = oFloor;
        }
    });




    $.Loader.advScript({
        name: 'default_dap_data',
        url: K_DEFAULT_DAP_DATA_PATH
    },{
        name: 'xxx',
        def: function() {


            $(function () {


                //模版在路上的时间 kay.liao
                $.Tpl.helper('MonthDayHour',function(timestamp){
                    timestamp *= 1000;
                    return ACT.getFmtTime('MM月dd日 hh点',timestamp,true);
                });


                //楼层渲染器
                var oFRHtml, oFRData, oFRBarr, oFRYYYY;

                //类行为 html 的楼层的渲染器
                oFRHtml = new FRHtml({
                    tpl: $('#basic-floor-tpl').html()
                });

                //类型为 data 的楼层的渲染器
                oFRData = new FRData({
                    tpl: $('#basic-floor-tpl').html(),
                    //隐藏已经下线的档期
                    hide_offline_brands: false,
                    //隐藏未上线的档期
                    hide_noready_brands: false,
                    //强制隐藏掉的档期
                    hide_these_brands: K_DEL_BRANDS,
                    //使用url里的actTime参数作为当前时间
                    set_now_with_urltime: true,
                    //在楼层为空时使用假数据的数量
                    num_fake_brands: K_NUM_FAKE_BRANDS,

                    //允许修改楼层和档期
                    modifyFloor: null,
                    modifyBrand: function(brand) {
                        // brand.state = 3;
                        return brand;
                    }
                });

                //类型为 html 并且有 kext-barr 标签的楼层的渲染器
                oFRBarr = new FRBArr({
                    tpl: $('#brands-floor-tpl').html(),
                    //隐藏已经下线的档期
                    hide_offline_brands: false,
                    //隐藏未上线的档期
                    hide_noready_brands: false,
                    //强制隐藏掉的档期
                    hide_these_brands: K_DEL_BRANDS,
                    //使用url里的actTime参数作为当前时间
                    set_now_with_urltime: true,
                    //在楼层为空时使用假数据的数量
                    num_fake_brands: K_NUM_FAKE_BRANDS,
                    //允许修改楼层和档期
                    modifyFloor: null,
                    //把所有档期都设置成预热状态
                    modifyBrand: function(brand) {
                        return brand;
                    }
                });

                //类型为 data 并且名字为 YYYY 的楼层的渲染器
                oFRYYYY = new FRData({
                    tpl: $('#basic-floor-tpl').html(),
                    //隐藏已经下线的档期
                    hide_offline_brands: false,
                    //隐藏未上线的档期
                    hide_noready_brands: false,
                    //强制隐藏掉的档期
                    hide_these_brands: K_DEL_BRANDS,
                    //使用url里的actTime参数作为当前时间
                    set_now_with_urltime: true,
                    //在楼层为空时使用假数据的数量
                    num_fake_brands: K_NUM_FAKE_BRANDS,

                    //只用于名字为 YYYY 的楼层， 可随意定制
                    canRender: function(oFloor) {
                        return oFloor && oFloor.type === 'data' && oFloor.ext.floor_code === 'YYYY';
                    },

                    //修改楼层，可随意定制
                    modifyFloor: function(oFloor) {
                        var aAddBrand, aShowBrand, warehouse;

                        warehouse = ACT.warehouse.toLowerCase();
                        //雷神工具生成的档期数组
                        aAddBrand = [
                            {
                                "vendor_sale_message": "",
                                "new_brand_image": "http://c.vpimg1.com/upcb/2016/01/21/25/22029844.jpg",
                                "id": "653344",
                                "name": "婴姿坊YINGZIFANG婴童服饰新年钜惠专场",
                                "discount": "<span>2</span>折起",
                                "display_starttime": "1453809600",
                                "display_endtime": "1454119140",
                                "state": 1,
                                "brand_store_sn": "10020873",
                                "slogan": "冬日上新 暖暖哒",
                                "vip_nh": "1",
                                "vip_sh": "0",
                                "vip_cd": "0",
                                "vip_bj": "0",
                                "vip_hz": "0"
                            },
                            {
                                "vendor_sale_message": "",
                                "new_brand_image": "http://d.vpimg1.com/upcb/2016/01/21/98/22219173.jpg",
                                "id": "653345",
                                "name": "婴姿坊YINGZIFANG婴童服饰新年钜惠专场",
                                "discount": "<span>2</span>折起",
                                "display_starttime": "1453809600",
                                "display_endtime": "1454119140",
                                "state": 1,
                                "brand_store_sn": "10020873",
                                "slogan": "冬日上新 暖暖哒",
                                "vip_nh": "0",
                                "vip_sh": "1",
                                "vip_cd": "0",
                                "vip_bj": "0",
                                "vip_hz": "0"
                            },
                            {
                                "vendor_sale_message": "",
                                "new_brand_image": "http://c.vpimg1.com/upcb/2016/01/21/93/22371662.jpg",
                                "id": "653346",
                                "name": "婴姿坊YINGZIFANG婴童服饰新年钜惠专场",
                                "discount": "<span>2</span>折起",
                                "display_starttime": "1453809600",
                                "display_endtime": "1454119140",
                                "state": 1,
                                "brand_store_sn": "10020873",
                                "slogan": "冬日上新 暖暖哒",
                                "vip_nh": "0",
                                "vip_sh": "0",
                                "vip_cd": "1",
                                "vip_bj": "0",
                                "vip_hz": "0"
                            },
                            {
                                "vendor_sale_message": "",
                                "new_brand_image": "http://c.vpimg1.com/upcb/2016/01/21/178/22537094.jpg",
                                "id": "653347",
                                "name": "婴姿坊YINGZIFANG婴童服饰新年钜惠专场",
                                "discount": "<span>2</span>折起",
                                "display_starttime": "1453809600",
                                "display_endtime": "1454119140",
                                "state": 1,
                                "brand_store_sn": "10020873",
                                "slogan": "冬日上新 暖暖哒",
                                "vip_nh": "0",
                                "vip_sh": "0",
                                "vip_cd": "0",
                                "vip_bj": "1",
                                "vip_hz": "0"
                            },
                            {
                                "vendor_sale_message": "",
                                "new_brand_image": "http://d.vpimg1.com/upcb/2016/01/21/37/23102134.jpg",
                                "id": "653348",
                                "name": "婴姿坊YINGZIFANG婴童服饰新年钜惠专场",
                                "discount": "<span>2</span>折起",
                                "display_starttime": "1453809600",
                                "display_endtime": "1454119140",
                                "state": 1,
                                "brand_store_sn": "10020873",
                                "slogan": "冬日上新 暖暖哒",
                                "vip_nh": "0",
                                "vip_sh": "0",
                                "vip_cd": "0",
                                "vip_bj": "0",
                                "vip_hz": "1"
                            }
                        ];
                        aShowBrand = [];

                        //过滤出当前区域的档期
                        $.each(aAddBrand, function(index, oBrand) {
                            if ( parseInt(oBrand[warehouse]) === 1 ) {
                                aShowBrand.push(oBrand);
                            }
                        });

                        //添加到当前楼层的档期数组前端
                        oFloor.mixedData = aShowBrand.concat(oFloor.mixedData);
                        return oFloor;
                    },

                    //修改档期, 可随意定制
                    modifyBrand: function(oBrand) {
                        if ( oBrand.id === 'MMMMMM' ) {
                            oBrand.name = 'UUUUUU';
                        }
                        return oBrand;
                    }
                });

                //指定渲染器
                DAP.addRender(oFRHtml);
                DAP.addRender(oFRData);
                DAP.addRender(oFRBarr);
                // DAP.addRender(oFRYYYY);

                //初始化
                DAP.init({
                    cmsId: 19706,
                    box: '#dap',

                    //允许定制总体渲染方案
                    render: null,

                    //允许定制错误提示方案
                    error: function (oDapReply) {
                        $('#J-loading-data-box').hide();
                        $('#J_repeat-data-box').show();
                        $('#J-refresh-data-btn').one('click', function (event) {
                            $('#J-loading-data-box').show();
                            $('#J_repeat-data-box').hide();
                            DAP.load();
                        });
                    },

                    //允许对响应进行修改
                    modify: function (oDapReply) {
                        var target, floors, i , l , floor, tgtfloor, aCopyFloor, oIsSub, oIsBrandFloor;
                        floors = oDapReply.result.floors || [];
                        target = ACT.getUrlPara('floorname');

                        oIsSub = {milk: 1, toy: 1, product: 1, child: 1, baby: 1};
                        oIsBrandFloor = {discount: 1, milk: 1, toy: 1, product: 1, child: 1, baby: 1, tomorrow: 1};



                        // $.each(oDapReply.result.floors, function(i, floor) {
                        //     VIPSHOP.log(floor);
                        // });


                        if ( target && oIsSub[target] ) {
                            for ( i = 0 , l = floors.length; i < l; i++ ) {
                                floor = floors[i];
                                if ( floor.ext.floor_code === target ) {
                                    //弹出目标楼层
                                    tgtfloor = floors.splice(i, 1)[0];
                                    //删除品购楼层并插入目标楼层
                                    // floors.splice(2, 0 , tgtfloor);
                                    K_SUBMALL_NAME = target;
                                    break;
                                }
                            }


                            if ( K_SUBMALL_NAME ) {
                                aCopyFloor = [];
                                $.each(floors, function(i, floor) {
                                    fname = floor.ext.floor_code;

                                    if ( oIsBrandFloor[fname] && fname !== K_SUBMALL_NAME ) {
                                        return;
                                    }

                                    if ( fname === 'category' ) {
                                        aCopyFloor.push(tgtfloor);
                                    }

                                    aCopyFloor.push(floor);
                                });



                                oDapReply.result.floors = floors = aCopyFloor;

                            }
                        }




                        var oNavDesp, oDesp;
                        oNavDesp = {
                            discount: {title: '298-60'},
                            milk: {title: '奶粉尿裤'},
                            product: {title: '母婴用品'},
                            toy: {title: '玩具文具'},
                            child: {title: '童装童鞋'},
                            baby: {title: '婴幼服饰'},
                            tomorrow: {title: '明天上新'}
                        };

                        $.each(floors, function(i, floor) {
                            if ( oDesp = oNavDesp[floor.ext.floor_code] ) {
                                floor.kext_navinfo = oDesp;
                            }
                        });



                        // $.each(floors, function(i, floor) {
                        //     if ( floor.type === 'data' ) {
                        //         floor.mixedData = [];
                        //     }
                        // });

                        return oDapReply;
                    },

                    ready: function (res) {
                        if ( K_SUBMALL_NAME ) {
                            $('#dap').addClass('k-submall k-submall-' + K_SUBMALL_NAME);
                        } else {
                            $('#dap').addClass('k-mainmall');
                        }


                        $('#J_slideBanner_wrap').hide();

                        $.Loader.advScript({
                            name: 'imgLazyload',
                            def: function () {
                                $('img.lazy').lazyload();
                            },
                            requires: ['lazyload']
                        });

                        Favorite.init();    //收藏功能
                        PMS.show();
                        Coupon.init();

                        if ( !K_SUBMALL_NAME ) {
                            ACT.navSensor.init({
                                //触发周期
                                scroll_exec_period: 100,
                                resize_exec_period: 100,
                                //窗口宽度临界值
                                critical_win_width: 1420,
                                //各楼层选择器或者jQ对象
                                floors: '.floor-navable',
                                //获取楼层的名字
                                getFloorName: function($floor) {
                                    return $floor.attr('data-floorid');
                                },
                                //参考点的y坐标, 默认为视口下边缘的视口坐标，可以传递具体的值
                                getPtClientY: function(winheight) {
                                    return 1;
                                }
                            });

                            Snav.init({
                                container: '#dap',
                                upperedge: $('#floor-top').height() + $('#vip-common-header').height(),
                                loweredge: $('#floor-bottom').height(),

                                tpl: $('#J_snav_tpl').html(),
                                data: {
                                    floors: res.result.floors,
                                    classes: '' //给导航加类
                                },
                                extFloors: function(floors) {
                                    return floors;
                                }
                            });

                            Bnav.init({
                                container: '#dap',
                                upperedge: $('#floor-top').height() + $('#vip-common-header').height(),
                                loweredge: $('#floor-bottom').height(),

                                tpl: $('#J_bnav_tpl').html(),
                                data: {
                                    floors: res.result.floors,
                                    classes: '' //给导航加类
                                },
                                extFloors: function(floors) {
                                    var sWidItem, aNavable, oInfo;

                                    oInfo = {
                                        hash_powder: {t1: '奶粉尿裤'},
                                        hash_jian: {t1: '婴童服饰'},
                                        hash_kiduse: {t1: '母婴用品'},
                                        trip: {t1: '出行用品'},
                                        toy: {t1: '玩具图书'},
                                        oversea: {t1: '全球好货'},
                                        sell: {t1: '童装锯惠'}
                                    };

                                    //导航项宽度
                                    aNavable = [];
                                    $.each(floors, function(index, floor) {
                                        if ( floor.ext.is_nav ) {
                                            aNavable.push(floor);
                                        }
                                    });

                                    sWidItem = (100 / aNavable.length ).toString().substr(0, 8) + '%';
                                    $.each(aNavable, function(index, floor) {
                                        floor.kext_bnav_wid = sWidItem;
                                        floor.kext_bnav_tips = oInfo[floor.ext.floor_code];
                                    });




                                    //导航文字

                                    return floors;
                                }
                            });
                        }

                    }
                });
            });
        },
        requires: ['default_dap_data']
    });
</script>